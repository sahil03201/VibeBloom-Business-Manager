<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeBloom Dashboard</title>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4a6fa5;
            --primary-light: #6a8fc5;
            --primary-dark: #2a4f85;
            --secondary: #166088;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --info: #17a2b8;
            --warning: #ffc107;
            --danger: #dc3545;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            transition: var(--transition);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--box-shadow);
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h3 {
            font-size: 22px;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .sidebar-header p {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 25px;
            color: white;
            text-decoration: none;
            transition: var(--transition);
            font-size: 15px;
            font-weight: 500;
            border-left: 4px solid transparent;
        }
        
        .sidebar-menu a:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-left-color: rgba(255, 255, 255, 0.3);
        }
        
        .sidebar-menu a.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-left-color: white;
        }
        
        .sidebar-menu i {
            margin-right: 12px;
            font-size: 18px;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 25px;
            background-color: #f5f7fa;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 25px;
            border-bottom: 1px solid #e0e6ed;
        }
        
        .header h2 {
            color: var(--primary);
            font-size: 24px;
            font-weight: 600;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info span {
            font-weight: 500;
        }
        
        .logout-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }
        
        .logout-btn:hover {
            text-decoration: underline;
        }
        
        /* Cards */
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 16px;
            color: var(--dark);
            font-weight: 500;
        }
        
        .card-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--primary);
        }
        
        /* Forms */
        .form-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .form-container h3 {
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 20px;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: var(--transition);
        }
        
        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn i {
            font-size: 16px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .btn-secondary {
            background-color: var(--gray);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        /* Tables */
        .table-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            overflow-x: auto;
        }
        
        .table-container h3 {
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 20px;
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #e0e6ed;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .badge-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .text-success {
            color: var(--success);
        }
        
        .text-danger {
            color: var(--danger);
        }
        
        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f5f7fa;
            background-image: linear-gradient(135deg, #f5f7fa 0%, #e4e8ed 100%);
        }
        
        .login-box {
            background: white;
            width: 100%;
            max-width: 450px;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
        }
        
        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
            font-size: 28px;
            font-weight: 600;
        }
        
        .login-logo {
            width: 80px;
            margin-bottom: 20px;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                width: 0;
                overflow: hidden;
            }
            
            .sidebar.active {
                width: 280px;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .menu-toggle {
                display: block;
                font-size: 24px;
                cursor: pointer;
                color: var(--primary);
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }
        
        @media (max-width: 768px) {
            .cards {
                grid-template-columns: 1fr;
            }
            
            .login-box {
                padding: 30px 20px;
            }
        }
        
        /* Calendar */
        .calendar-container {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .date-picker {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 14px;
        }
        
        /* File Upload */
        .file-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            background-color: #f8f9fa;
            transition: var(--transition);
            cursor: pointer;
        }
        
        .file-upload:hover {
            border-color: var(--primary);
            background-color: rgba(74, 111, 165, 0.05);
        }
        
        .file-upload input {
            display: none;
        }
        
        .file-upload label {
            cursor: pointer;
            color: var(--primary);
            font-weight: 500;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .file-upload small {
            color: var(--gray);
            font-size: 13px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            color: var(--gray);
            transition: var(--transition);
        }
        
        .tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }
        
        /* Hidden class */
        .hidden {
            display: none;
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .delete-btn {
            color: var(--danger);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
        }
        
        .delete-btn:hover {
            text-decoration: underline;
        }
        
        .edit-btn {
            color: var(--warning);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
        }
        
        .edit-btn:hover {
            text-decoration: underline;
        }
        
        /* Offer section */
        .offer-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border: 1px solid #e0e6ed;
        }
        
        .offer-section h4 {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 16px;
            font-weight: 600;
        }
        
        /* Discount entry */
        .discount-entry {
            margin-bottom: 10px;
            padding: 12px;
            background-color: white;
            border-radius: var(--border-radius);
            border: 1px solid #e0e6ed;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Toggle switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        .toggle-label {
            margin-left: 10px;
            vertical-align: middle;
            font-size: 14px;
            font-weight: 500;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Button group */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* View receipt modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            overflow: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .close-modal {
            color: var(--gray);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close-modal:hover {
            color: var(--dark);
        }
        
        #pdf-viewer {
            width: 100%;
            height: 70vh;
            border: 1px solid #ddd;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 50px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: normal;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Status indicators */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-active {
            background-color: var(--success);
        }
        
        .status-inactive {
            background-color: var(--danger);
        }
        
        /* Enhanced table actions */
        .table-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Responsive tables */
        @media (max-width: 768px) {
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
        
        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary);
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background-color: var(--success);
        }
        
        .toast.error {
            background-color: var(--danger);
        }
        
        .toast i {
            font-size: 20px;
        }
        
        /* Search box */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 14px;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
    </style>
</head>
<body>
    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i>✓</i>
        <span id="toast-message">Operation successful</span>
    </div>

    <!-- PDF Viewer Modal -->
    <div id="pdf-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="pdf-viewer"></div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="login-container">
        <div class="login-box">
            <h2 class="login-title">VibeBloom Dashboard</h2>
            <div class="form-group">
                <label for="username">Email</label>
                <input type="email" id="username" class="form-control" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password">
            </div>
            <button id="login-btn" class="btn btn-primary" style="width: 100%;">
                <i>🔑</i> Login
            </button>
            <div id="login-spinner" class="spinner"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>VibeBloom</h3>
                <p>Sahil & Aarif</p>
            </div>
            <div class="sidebar-menu">
                <a href="#" class="active" data-section="home"><i>🏠</i> Home</a>
                <a href="#" data-section="investment"><i>💰</i> Investment Tracker</a>
                <a href="#" data-section="expense"><i>📊</i> Expense Tracker</a>
                <a href="#" data-section="profit"><i>📈</i> Profit Tracker</a>
                <a href="#" data-section="profit-sharing"><i>🤝</i> Profit Sharing</a>
                <a href="#" data-section="receipts"><i>📎</i> Upload Receipts</a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h2 id="section-title">Home</h2>
                <div class="user-info">
                    <span id="logged-in-user"></span>
                    <button class="logout-btn"><i>🚪</i> Logout</button>
                </div>
            </div>

            <!-- Home Section -->
            <div id="home-section" class="section-content">
                <div class="cards">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Total Investment</span>
                            <i>💰</i>
                        </div>
                        <div class="card-value" id="total-investment">₹0</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Total Expenses</span>
                            <i>📊</i>
                        </div>
                        <div class="card-value" id="total-expenses">₹0</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Total Profit</span>
                            <i>📈</i>
                        </div>
                        <div class="card-value" id="total-profit">₹0</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Your Share</span>
                            <i>🤝</i>
                        </div>
                        <div class="card-value" id="your-share">₹0</div>
                    </div>
                </div>

                <div class="form-container">
                    <h3>Welcome to VibeBloom</h3>
                    <p>This dashboard helps us track our business finances and manage our partnership effectively.</p>
                    <p><strong>Business Model:</strong> We source products from suppliers and sell them directly to customers without holding inventory.</p>
                    <p><strong>Profit Sharing:</strong> 50/50 split between Sahil and Aarif.</p>
                    
                    <div class="cards" style="margin-top: 30px; grid-template-columns: 1fr 1fr;">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Recent Sales</span>
                                <i>🛒</i>
                            </div>
                            <div id="recent-sales-list">
                                <!-- Will be populated dynamically -->
                                <p class="empty-state">No recent sales</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Recent Expenses</span>
                                <i>💸</i>
                            </div>
                            <div id="recent-expenses-list">
                                <!-- Will be populated dynamically -->
                                <p class="empty-state">No recent expenses</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Investment Tracker Section -->
            <div id="investment-section" class="section-content hidden">
                <div class="form-container">
                    <h3>Add New Investment</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invest-date">Date</label>
                            <input type="date" id="invest-date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="invest-partner">Partner</label>
                            <select id="invest-partner" class="form-control">
                                <option value="sahil">Sahil</option>
                                <option value="aarif">Aarif</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invest-amount">Amount (₹)</label>
                            <input type="number" id="invest-amount" class="form-control" placeholder="Enter amount">
                        </div>
                        <div class="form-group">
                            <label for="invest-category">Category</label>
                            <select id="invest-category" class="form-control">
                                <option value="ads">Ads</option>
                                <option value="website">Website</option>
                                <option value="product_research">Product Research</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" id="custom-category-group" style="display: none;">
                        <label for="invest-custom-category">Custom Category</label>
                        <input type="text" id="invest-custom-category" class="form-control" placeholder="Enter custom category">
                    </div>
                    <div class="form-group">
                        <label for="invest-notes">Notes</label>
                        <textarea id="invest-notes" class="form-control" rows="2" placeholder="Any additional notes"></textarea>
                    </div>
                    <div class="btn-group">
                        <button id="add-investment" class="btn btn-primary">
                            <i>➕</i> Add Investment
                        </button>
                        <button id="cancel-edit-investment" class="btn btn-danger hidden">
                            <i>✖</i> Cancel
                        </button>
                    </div>
                    <div id="investment-spinner" class="spinner"></div>
                </div>

                <div class="calendar-container">
                    <label for="investment-date-filter">Filter by Date:</label>
                    <input type="date" id="investment-date-filter" class="date-picker">
                    <button id="reset-investment-filter" class="btn btn-secondary">
                        <i>🔄</i> Show All
                    </button>
                </div>

                <div class="table-container">
                    <h3>Investment Summary</h3>
                    <div class="cards">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Sahil's Investment</span>
                                <i>👤</i>
                            </div>
                            <div class="card-value" id="sahil-investment">₹0</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Aarif's Investment</span>
                                <i>👤</i>
                            </div>
                            <div class="card-value" id="aarif-investment">₹0</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Total Investment</span>
                                <i>💰</i>
                            </div>
                            <div class="card-value" id="total-investment-summary">₹0</div>
                        </div>
                    </div>

                    <h3>Investment History</h3>
                    <div class="search-box">
                        <i>🔍</i>
                        <input type="text" id="investment-search" placeholder="Search investments...">
                    </div>
                    <table id="investment-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Partner</th>
                                <th>Amount</th>
                                <th>Category</th>
                                <th>Notes</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Expense Tracker Section -->
            <div id="expense-section" class="section-content hidden">
                <div class="form-container">
                    <h3>Add New Expense</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expense-date">Date</label>
                            <input type="date" id="expense-date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="expense-amount">Amount (₹)</label>
                            <input type="number" id="expense-amount" class="form-control" placeholder="Enter amount">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expense-category">Category</label>
                            <select id="expense-category" class="form-control">
                                <option value="ads">Ads</option>
                                <option value="packaging">Packaging</option>
                                <option value="shipping">Shipping</option>
                                <option value="subscriptions">Subscriptions</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expense-paid-by">Paid By</label>
                            <select id="expense-paid-by" class="form-control">
                                <option value="sahil">Sahil</option>
                                <option value="aarif">Aarif</option>
                                <option value="business">Business Account</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" id="expense-custom-category-group" style="display: none;">
                        <label for="expense-custom-category">Custom Category</label>
                        <input type="text" id="expense-custom-category" class="form-control" placeholder="Enter custom category">
                    </div>
                    <div class="form-group">
                        <label for="expense-notes">Notes</label>
                        <textarea id="expense-notes" class="form-control" rows="2" placeholder="Any additional notes"></textarea>
                    </div>
                    <div class="btn-group">
                        <button id="add-expense" class="btn btn-primary">
                            <i>➕</i> Add Expense
                        </button>
                        <button id="cancel-edit-expense" class="btn btn-danger hidden">
                            <i>✖</i> Cancel
                        </button>
                    </div>
                    <div id="expense-spinner" class="spinner"></div>
                </div>

                <div class="calendar-container">
                    <label for="expense-date-filter">Filter by Date:</label>
                    <input type="date" id="expense-date-filter" class="date-picker">
                    <button id="reset-expense-filter" class="btn btn-secondary">
                        <i>🔄</i> Show All
                    </button>
                </div>

                <div class="table-container">
                    <h3>Expense Summary</h3>
                    <div class="cards">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Total Expenses</span>
                                <i>📊</i>
                            </div>
                            <div class="card-value" id="total-expenses-summary">₹0</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">This Month</span>
                                <i>📅</i>
                            </div>
                            <div class="card-value" id="monthly-expenses">₹0</div>
                        </div>
                    </div>

                    <h3>Expense History</h3>
                    <div class="search-box">
                        <i>🔍</i>
                        <input type="text" id="expense-search" placeholder="Search expenses...">
                    </div>
                    <table id="expense-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Category</th>
                                <th>Paid By</th>
                                <th>Notes</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Profit Tracker Section -->
            <div id="profit-section" class="section-content hidden">
                <div class="form-container">
                    <h3>Add New Sale</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sale-date">Date</label>
                            <input type="date" id="sale-date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="product-name">Product Name</label>
                            <input type="text" id="product-name" class="form-control" placeholder="Enter product name">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="quantity-sold">Quantity Sold</label>
                            <input type="number" id="quantity-sold" class="form-control" placeholder="Enter quantity">
                        </div>
                        <div class="form-group">
                            <label for="sale-price">Sale Price (₹)</label>
                            <input type="number" id="sale-price" class="form-control" placeholder="Price per unit">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-cost">Product Cost (₹)</label>
                            <input type="number" id="product-cost" class="form-control" placeholder="Cost per unit">
                        </div>
                        <div class="form-group">
                            <label for="total-ads-cost">Total Ads Cost (₹)</label>
                            <input type="number" id="total-ads-cost" class="form-control" placeholder="Total ads cost">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="packaging-cost">Packaging Cost (₹)</label>
                            <input type="number" id="packaging-cost" class="form-control" placeholder="Packaging cost" value="0">
                        </div>
                        <div class="form-group">
                            <label for="shipping-cost">Shipping Cost (₹)</label>
                            <input type="number" id="shipping-cost" class="form-control" placeholder="Shipping cost" value="0">
                        </div>
                    </div>
                    
                    <!-- RTO Section -->
                    <div class="offer-section">
                        <h4>RTO Details</h4>
                        <div class="toggle-container">
                            <label class="switch">
                                <input type="checkbox" id="rto-method-toggle">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label" id="rto-method-label">Calculate by Quantity</span>
                        </div>
                        <div id="rto-quantity-section">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="rto-quantity">RTO Quantity</label>
                                    <input type="number" id="rto-quantity" class="form-control" placeholder="Enter RTO quantity" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="rto-charge">RTO Charge (₹)</label>
                                    <input type="number" id="rto-charge" class="form-control" placeholder="RTO charge per unit" value="0">
                                </div>
                            </div>
                        </div>
                        <div id="rto-percentage-section" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="rto-percentage">RTO Percentage (%)</label>
                                    <input type="number" id="rto-percentage" class="form-control" placeholder="Enter RTO percentage" value="0" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label for="rto-percentage-charge">RTO Charge (₹)</label>
                                    <input type="number" id="rto-percentage-charge" class="form-control" placeholder="RTO charge per unit" value="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Other Charges Section -->
                    <div class="offer-section">
                        <h4>Other Charges</h4>
                        <div id="other-charges-container">
                            <p class="empty-state">No other charges added</p>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="other-charge-name">Charge Name</label>
                                <input type="text" id="other-charge-name" class="form-control" placeholder="Enter charge name">
                            </div>
                            <div class="form-group">
                                <label for="other-charge-type">Charge Type</label>
                                <select id="other-charge-type" class="form-control">
                                    <option value="fixed">Fixed Amount</option>
                                    <option value="percentage">Percentage</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="other-charge-value">Value</label>
                                <input type="number" id="other-charge-value" class="form-control" placeholder="Enter value">
                            </div>
                        </div>
                        <button id="add-other-charge" class="btn btn-primary" style="margin-top: 10px;">
                            <i>➕</i> Add Charge
                        </button>
                    </div>
                    
                    <!-- Enhanced Discount Section -->
                    <div class="offer-section">
                        <h4>Discount Details</h4>
                        <div id="discount-container">
                            <p class="empty-state">No discounts added</p>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="discount-quantity">Quantity for Discount</label>
                                <input type="number" id="discount-quantity" class="form-control" placeholder="Quantity" min="1" value="">
                            </div>
                            <div class="form-group">
                                <label for="discount-type">Discount Type</label>
                                <select id="discount-type" class="form-control">
                                    <option value="percentage">Percentage</option>
                                    <option value="fixed">Fixed Amount</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="discount-value">Discount Value</label>
                                <input type="number" id="discount-value" class="form-control" placeholder="Enter discount">
                            </div>
                        </div>
                        <button id="add-discount" class="btn btn-primary" style="margin-top: 10px;">
                            <i>➕</i> Add Discount
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="sale-notes">Notes</label>
                        <textarea id="sale-notes" class="form-control" rows="2" placeholder="Any additional notes"></textarea>
                    </div>
                    <div class="btn-group">
                        <button id="add-sale" class="btn btn-primary">
                            <i>➕</i> Add Sale
                        </button>
                        <button id="cancel-edit-sale" class="btn btn-danger hidden">
                            <i>✖</i> Cancel
                        </button>
                    </div>
                    <div id="sale-spinner" class="spinner"></div>
                </div>

                <div class="calendar-container">
                    <label for="profit-date-filter">Filter by Date:</label>
                    <input type="date" id="profit-date-filter" class="date-picker">
                    <button id="reset-profit-filter" class="btn btn-secondary">
                        <i>🔄</i> Show All
                    </button>
                </div>

                <div class="table-container">
                    <h3>Profit Summary</h3>
                    <div class="cards">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Total Sales (After Discount)</span>
                                <i>💰</i>
                            </div>
                            <div class="card-value" id="total-sales">₹0</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Total Cost</span>
                                <i>📉</i>
                            </div>
                            <div class="card-value" id="total-cost">₹0</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Total Margin</span>
                                <i>📊</i>
                            </div>
                            <div class="card-value" id="total-margin">₹0</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Total Profit</span>
                                <i>📈</i>
                            </div>
                            <div class="card-value" id="total-profit-summary">₹0</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Total RTO Cost</span>
                                <i>📦</i>
                            </div>
                            <div class="card-value" id="total-rto-cost">₹0</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Total Other Charges</span>
                                <i>🧾</i>
                            </div>
                            <div class="card-value" id="total-other-charges">₹0</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Total Discount</span>
                                <i>🎁</i>
                            </div>
                            <div class="card-value" id="total-discount">₹0</div>
                        </div>
                    </div>

                    <h3>Sales History</h3>
                    <div class="search-box">
                        <i>🔍</i>
                        <input type="text" id="profit-search" placeholder="Search sales...">
                    </div>
                    <table id="profit-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Product</th>
                                <th>Qty</th>
                                <th>Sale Price</th>
                                <th>Discount</th>
                                <th>Cost</th>
                                <th>Ads Cost</th>
                                <th>RTO Cost</th>
                                <th>Other Charges</th>
                                <th>Packaging</th>
                                <th>Shipping</th>
                                <th>Margin</th>
                                <th>Profit</th>
                                <th>Notes</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Profit Sharing Section -->
            <div id="profit-sharing-section" class="section-content hidden">
                <div class="form-container">
                    <h3>Profit Sharing Calculator</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="profit-month">Month</label>
                            <select id="profit-month" class="form-control">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="profit-year">Year</label>
                            <input type="number" id="profit-year" class="form-control" value="2023" min="2020" max="2030">
                        </div>
                    </div>
                    <button id="calculate-profit" class="btn btn-primary">
                        <i>🧮</i> Calculate Profit Share
                    </button>
                    <div id="profit-sharing-spinner" class="spinner"></div>
                </div>

                <div class="table-container">
                    <h3>Profit Sharing Summary</h3>
                    <div class="cards">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Total Profit</span>
                                <i>💰</i>
                            </div>
                            <div class="card-value" id="monthly-total-profit">₹0</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Sahil's Share (50%)</span>
                                <i>👤</i>
                            </div>
                            <div class="card-value" id="sahil-share">₹0</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Aarif's Share (50%)</span>
                                <i>👤</i>
                            </div>
                            <div class="card-value" id="aarif-share">₹0</div>
                        </div>
                    </div>

                    <h3>Profit Sharing Details</h3>
                    <div class="search-box">
                        <i>🔍</i>
                        <input type="text" id="profit-sharing-search" placeholder="Search profit sharing...">
                    </div>
                    <table id="profit-sharing-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Total Profit</th>
                                <th>Sahil's Share</th>
                                <th>Aarif's Share</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Upload Receipts Section -->
            <div id="receipts-section" class="section-content hidden">
                <div class="form-container">
                    <h3>Upload Receipts/Notes</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="receipt-date">Date</label>
                            <input type="date" id="receipt-date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="receipt-type">Type</label>
                            <select id="receipt-type" class="form-control">
                                <option value="invoice">Invoice</option>
                                <option value="receipt">Receipt</option>
                                <option value="note">Note</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="receipt-description">Description</label>
                        <input type="text" id="receipt-description" class="form-control" placeholder="Enter description">
                    </div>
                    <div class="file-upload">
                        <input type="file" id="receipt-file" accept="image/*,.pdf">
                        <label for="receipt-file">📁 Choose file or drag here</label>
                        <small>Supports JPG, PNG, PDF (Max 5MB)</small>
                    </div>
                    <div id="file-preview" style="display: none; margin-bottom: 15px;">
                        <img id="preview-image" src="#" alt="Preview" style="max-width: 100%; max-height: 200px; display: none;">
                        <div id="file-info"></div>
                    </div>
                    <div class="btn-group">
                        <button id="upload-receipt" class="btn btn-primary">
                            <i>📤</i> Upload
                        </button>
                        <button id="cancel-edit-receipt" class="btn btn-danger hidden">
                            <i>✖</i> Cancel
                        </button>
                    </div>
                    <div id="receipt-spinner" class="spinner"></div>
                </div>

                <div class="calendar-container">
                    <label for="receipt-date-filter">Filter by Date:</label>
                    <input type="date" id="receipt-date-filter" class="date-picker">
                    <button id="reset-receipt-filter" class="btn btn-secondary">
                        <i>🔄</i> Show All
                    </button>
                </div>

                <div class="table-container">
                    <h3>Uploaded Receipts & Notes</h3>
                    <div class="search-box">
                        <i>🔍</i>
                        <input type="text" id="receipts-search" placeholder="Search receipts...">
                    </div>
                    <table id="receipts-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>File</th>
                                <th>Uploaded By</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Initialize Firebase with your config
const firebaseConfig = {
    apiKey: "AIzaSyDWOMCKxWeKCK5mKiCZGxTEK51L1Dbip1c",
    authDomain: "vibebloom-5a07f.firebaseapp.com",
    databaseURL: "https://vibebloom-5a07f-default-rtdb.firebaseio.com",
    projectId: "vibebloom-5a07f",
    storageBucket: "vibebloom-5a07f.appspot.com",
    messagingSenderId: "551501707532",
    appId: "1:551501707532:web:6e30bd812fad8a12e03129"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

// Initialize PDF.js
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

// Track all Firebase references
const firebaseRefs = {
    businessData: null,
    investments: null,
    expenses: null,
    sales: null,
    receipts: null,
    profitSharing: null
};

// Current user
let currentUser = null;

// Data storage
let businessData = {
    investments: [],
    expenses: [],
    sales: [],
    receipts: [],
    profitSharing: []
};

// Discount entries for current sale
let discountEntries = [];
let otherCharges = [];
let rtoCalculationMethod = false;

// Currently editing items
let currentlyEditing = {
    investment: null,
    expense: null,
    sale: null,
    receipt: null
};

// Function to clean up all Firebase listeners
function cleanupFirebaseListeners() {
    Object.keys(firebaseRefs).forEach(key => {
        if (firebaseRefs[key]) {
            firebaseRefs[key].off();
            firebaseRefs[key] = null;
        }
    });
}

// Show toast notification
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    
    toastMessage.textContent = message;
    toast.className = `toast ${type}`;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Load data from Firebase
function loadData() {
    showLoading('login-spinner');
    
    // Clean up previous listeners
    cleanupFirebaseListeners();
    
    // Set up new listeners
    firebaseRefs.businessData = database.ref('businessData');
    
    firebaseRefs.businessData.on('value', (snapshot) => {
        hideLoading('login-spinner');
        const data = snapshot.val();
        
        if (data) {
            // Convert all nested objects to arrays with Firebase keys
            businessData = {
                investments: data.investments ? Object.entries(data.investments).map(([firebaseId, item]) => ({ 
                    firebaseId, 
                    ...item 
                })) : [],
                expenses: data.expenses ? Object.entries(data.expenses).map(([firebaseId, item]) => ({ 
                    firebaseId, 
                    ...item 
                })) : [],
                sales: data.sales ? Object.entries(data.sales).map(([firebaseId, item]) => ({ 
                    firebaseId, 
                    ...item 
                })) : [],
                receipts: data.receipts ? Object.entries(data.receipts).map(([firebaseId, item]) => ({ 
                    firebaseId, 
                    ...item 
                })) : [],
                profitSharing: data.profitSharing ? Object.entries(data.profitSharing).map(([firebaseId, item]) => ({ 
                    firebaseId, 
                    ...item 
                })) : []
            };
            
            updateDashboard();
            updateRecentActivity();
        } else {
            // Initialize with empty data if no data exists
            firebaseRefs.businessData.set({
                investments: {},
                expenses: {},
                sales: {},
                receipts: {},
                profitSharing: {}
            });
        }
    }, (error) => {
        hideLoading('login-spinner');
        console.error("Error loading data: ", error);
        showToast("Error loading data. Please try again.", "error");
    });
    
    // Set up individual listeners for each section
    setupSectionListeners();
}

function setupSectionListeners() {
    // Investments
    firebaseRefs.investments = database.ref('businessData/investments');
    firebaseRefs.investments.on('value', () => updateInvestmentTable());
    
    // Expenses
    firebaseRefs.expenses = database.ref('businessData/expenses');
    firebaseRefs.expenses.on('value', () => updateExpenseTable());
    
    // Sales
    firebaseRefs.sales = database.ref('businessData/sales');
    firebaseRefs.sales.on('value', () => updateProfitTable());
    
    // Receipts
    firebaseRefs.receipts = database.ref('businessData/receipts');
    firebaseRefs.receipts.on('value', () => updateReceiptsTable());
    
    // Profit Sharing
    firebaseRefs.profitSharing = database.ref('businessData/profitSharing');
    firebaseRefs.profitSharing.on('value', () => updateProfitSharingTable());
}

// Show loading spinner
function showLoading(elementId) {
    const spinner = document.getElementById(elementId);
    if (spinner) {
        spinner.style.display = 'block';
    }
}

// Hide loading spinner
function hideLoading(elementId) {
    const spinner = document.getElementById(elementId);
    if (spinner) {
        spinner.style.display = 'none';
    }
}

// Login function
document.getElementById('login-btn').addEventListener('click', function() {
    const email = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
        showToast('Please enter both email and password', 'error');
        return;
    }
    
    showLoading('login-spinner');
    
    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // Signed in
            currentUser = userCredential.user.email;
            document.getElementById('logged-in-user').textContent = currentUser.split('@')[0];
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadData();
            showToast('Login successful');
        })
        .catch((error) => {
            hideLoading('login-spinner');
            showToast('Invalid email or password', 'error');
            console.error("Login error: ", error);
        });
});

// Logout function
document.querySelector('.logout-btn').addEventListener('click', function() {
    auth.signOut().then(() => {
        currentUser = null;
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('login-page').classList.remove('hidden');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        cleanupFirebaseListeners();
        showToast('Logged out successfully');
    }).catch((error) => {
        console.error("Logout error: ", error);
        showToast('Error logging out', 'error');
    });
});

// Check auth state on page load
auth.onAuthStateChanged((user) => {
    if (user) {
        // User is signed in
        currentUser = user.email;
        document.getElementById('logged-in-user').textContent = currentUser.split('@')[0];
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        
        // Load data only if we're not already loaded
        if (!firebaseRefs.businessData) {
            loadData();
        }
    } else {
        // User is signed out
        currentUser = null;
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('login-page').classList.remove('hidden');
        
        // Clean up all Firebase listeners
        cleanupFirebaseListeners();
    }
});

// Navigation
document.querySelectorAll('.sidebar-menu a').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const section = this.getAttribute('data-section');
        
        // Update active link
        document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
        this.classList.add('active');
        
        // Update section title
        document.getElementById('section-title').textContent = this.textContent.trim();
        
        // Show selected section
        document.querySelectorAll('.section-content').forEach(div => div.classList.add('hidden'));
        document.getElementById(`${section}-section`).classList.remove('hidden');
    });
});

// Investment Tracker
document.getElementById('invest-category').addEventListener('change', function() {
    document.getElementById('custom-category-group').style.display = 
        this.value === 'other' ? 'block' : 'none';
});

// Setup investment form handlers
function setupInvestmentFormHandlers(mode, firebaseId = null) {
    const addBtn = document.getElementById('add-investment');
    const newAddBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newAddBtn, addBtn);
    
    if (mode === 'add') {
        newAddBtn.innerHTML = '<i>➕</i> Add Investment';
        newAddBtn.addEventListener('click', addNewInvestment);
    } else {
        newAddBtn.innerHTML = '<i>🔄</i> Update Investment';
        newAddBtn.addEventListener('click', function() { updateInvestment(firebaseId); });
    }
}

// Edit Investment
window.editInvestment = function(firebaseId) {
    const investment = businessData.investments.find(inv => inv.firebaseId === firebaseId);
    if (!investment) return;

    // Set currently editing
    currentlyEditing.investment = firebaseId;
    document.getElementById('cancel-edit-investment').classList.remove('hidden');

    // Populate form
    document.getElementById('invest-date').value = investment.date;
    document.getElementById('invest-partner').value = investment.partner;
    document.getElementById('invest-amount').value = investment.amount;
    
    // Handle category
    const isOtherCategory = !['ads', 'website', 'product_research'].includes(investment.category);
    document.getElementById('invest-category').value = isOtherCategory ? 'other' : investment.category;
    if (isOtherCategory) {
        document.getElementById('custom-category-group').style.display = 'block';
        document.getElementById('invest-custom-category').value = investment.category;
    }
    
    document.getElementById('invest-notes').value = investment.notes || '';
    
    // Setup handlers
    setupInvestmentFormHandlers('edit', firebaseId);
    
    // Scroll to form
    document.getElementById('investment-section').scrollIntoView({ behavior: 'smooth' });
};

// Cancel edit investment
document.getElementById('cancel-edit-investment').addEventListener('click', function() {
    resetInvestmentForm();
});

function resetInvestmentForm() {
    document.getElementById('invest-date').value = '';
    document.getElementById('invest-partner').value = 'sahil';
    document.getElementById('invest-amount').value = '';
    document.getElementById('invest-category').value = 'ads';
    document.getElementById('custom-category-group').style.display = 'none';
    document.getElementById('invest-custom-category').value = '';
    document.getElementById('invest-notes').value = '';
    
    // Reset button handlers
    setupInvestmentFormHandlers('add');
    
    document.getElementById('cancel-edit-investment').classList.add('hidden');
    currentlyEditing.investment = null;
}

// Add new investment
function addNewInvestment() {
    const date = document.getElementById('invest-date').value;
    const partner = document.getElementById('invest-partner').value;
    const amount = parseFloat(document.getElementById('invest-amount').value);
    let category = document.getElementById('invest-category').value;
    const notes = document.getElementById('invest-notes').value;
    
    if (category === 'other') {
        category = document.getElementById('invest-custom-category').value || 'Other';
    }
    
    if (!date || isNaN(amount) || amount <= 0) {
        showToast('Please enter valid date and amount', 'error');
        return;
    }
    
    showLoading('investment-spinner');
    
    const newInvestment = {
        date,
        partner,
        amount,
        category,
        notes,
        addedBy: currentUser,
        timestamp: new Date().toISOString()
    };
    
    // Push to Firebase
    database.ref('businessData/investments').push(newInvestment)
        .then(() => {
            hideLoading('investment-spinner');
            resetInvestmentForm();
            showToast('Investment added successfully');
        })
        .catch((error) => {
            hideLoading('investment-spinner');
            console.error("Error adding investment: ", error);
            showToast('Error adding investment', 'error');
        });
}

// Update investment
async function updateInvestment(firebaseId) {
    const date = document.getElementById('invest-date').value;
    const partner = document.getElementById('invest-partner').value;
    const amount = parseFloat(document.getElementById('invest-amount').value);
    let category = document.getElementById('invest-category').value;
    const notes = document.getElementById('invest-notes').value;
    
    if (category === 'other') {
        category = document.getElementById('invest-custom-category').value || 'Other';
    }
    
    if (!date || isNaN(amount) || amount <= 0) {
        showToast('Please enter valid date and amount', 'error');
        return;
    }
    
    showLoading('investment-spinner');
    
    const updatedInvestment = {
        date,
        partner,
        amount,
        category,
        notes,
        updatedBy: currentUser,
        updatedAt: new Date().toISOString()
    };
    
    try {
        // Update in Firebase
        await database.ref(`businessData/investments/${firebaseId}`).update(updatedInvestment);
        
        hideLoading('investment-spinner');
        resetInvestmentForm();
        showToast('Investment updated successfully');
    } catch (error) {
        hideLoading('investment-spinner');
        console.error("Error updating investment: ", error);
        showToast('Error updating investment', 'error');
    }
}

// Expense Tracker
document.getElementById('expense-category').addEventListener('change', function() {
    document.getElementById('expense-custom-category-group').style.display = 
        this.value === 'other' ? 'block' : 'none';
});

// Setup expense form handlers
function setupExpenseFormHandlers(mode, firebaseId = null) {
    const addBtn = document.getElementById('add-expense');
    const newAddBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newAddBtn, addBtn);
    
    if (mode === 'add') {
        newAddBtn.innerHTML = '<i>➕</i> Add Expense';
        newAddBtn.addEventListener('click', addNewExpense);
    } else {
        newAddBtn.innerHTML = '<i>🔄</i> Update Expense';
        newAddBtn.addEventListener('click', function() { updateExpense(firebaseId); });
    }
}

// Edit Expense
window.editExpense = function(firebaseId) {
    const expense = businessData.expenses.find(exp => exp.firebaseId === firebaseId);
    if (!expense) return;

    // Set currently editing
    currentlyEditing.expense = firebaseId;
    document.getElementById('cancel-edit-expense').classList.remove('hidden');

    // Populate form
    document.getElementById('expense-date').value = expense.date;
    document.getElementById('expense-amount').value = expense.amount;
    
    // Handle category
    const isOtherCategory = !['ads', 'packaging', 'shipping', 'subscriptions'].includes(expense.category);
    document.getElementById('expense-category').value = isOtherCategory ? 'other' : expense.category;
    if (isOtherCategory) {
        document.getElementById('expense-custom-category-group').style.display = 'block';
        document.getElementById('expense-custom-category').value = expense.category;
    }
    
    document.getElementById('expense-paid-by').value = expense.paidBy;
    document.getElementById('expense-notes').value = expense.notes || '';
    
    // Setup handlers
    setupExpenseFormHandlers('edit', firebaseId);
    
    // Scroll to form
    document.getElementById('expense-section').scrollIntoView({ behavior: 'smooth' });
};

// Cancel edit expense
document.getElementById('cancel-edit-expense').addEventListener('click', function() {
    resetExpenseForm();
});

function resetExpenseForm() {
    document.getElementById('expense-date').value = '';
    document.getElementById('expense-amount').value = '';
    document.getElementById('expense-category').value = 'ads';
    document.getElementById('expense-custom-category-group').style.display = 'none';
    document.getElementById('expense-custom-category').value = '';
    document.getElementById('expense-paid-by').value = 'sahil';
    document.getElementById('expense-notes').value = '';
    
    // Reset button handlers
    setupExpenseFormHandlers('add');
    
    document.getElementById('cancel-edit-expense').classList.add('hidden');
    currentlyEditing.expense = null;
}

// Add new expense
function addNewExpense() {
    const date = document.getElementById('expense-date').value;
    const amount = parseFloat(document.getElementById('expense-amount').value);
    let category = document.getElementById('expense-category').value;
    const paidBy = document.getElementById('expense-paid-by').value;
    const notes = document.getElementById('expense-notes').value;
    
    if (category === 'other') {
        category = document.getElementById('expense-custom-category').value || 'Other';
    }
    
    if (!date || isNaN(amount) || amount <= 0) {
        showToast('Please enter valid date and amount', 'error');
        return;
    }
    
    showLoading('expense-spinner');
    
    const newExpense = {
        date,
        amount,
        category,
        paidBy,
        notes,
        addedBy: currentUser,
        timestamp: new Date().toISOString()
    };
    
    // Push to Firebase
    database.ref('businessData/expenses').push(newExpense)
        .then(() => {
            hideLoading('expense-spinner');
            resetExpenseForm();
            showToast('Expense added successfully');
        })
        .catch((error) => {
            hideLoading('expense-spinner');
            console.error("Error adding expense: ", error);
            showToast('Error adding expense', 'error');
        });
}

// Update expense
async function updateExpense(firebaseId) {
    const date = document.getElementById('expense-date').value;
    const amount = parseFloat(document.getElementById('expense-amount').value);
    let category = document.getElementById('expense-category').value;
    const paidBy = document.getElementById('expense-paid-by').value;
    const notes = document.getElementById('expense-notes').value;
    
    if (category === 'other') {
        category = document.getElementById('expense-custom-category').value || 'Other';
    }
    
    if (!date || isNaN(amount) || amount <= 0) {
        showToast('Please enter valid date and amount', 'error');
        return;
    }
    
    showLoading('expense-spinner');
    
    const updatedExpense = {
        date,
        amount,
        category,
        paidBy,
        notes,
        updatedBy: currentUser,
        updatedAt: new Date().toISOString()
    };
    
    try {
        // Update in Firebase
        await database.ref(`businessData/expenses/${firebaseId}`).update(updatedExpense);
        
        hideLoading('expense-spinner');
        resetExpenseForm();
        showToast('Expense updated successfully');
    } catch (error) {
        hideLoading('expense-spinner');
        console.error("Error updating expense: ", error);
        showToast('Error updating expense', 'error');
    }
}

// RTO Method Toggle
document.getElementById('rto-method-toggle').addEventListener('change', function() {
    rtoCalculationMethod = this.checked;
    if (this.checked) {
        document.getElementById('rto-method-label').textContent = 'Calculate by Percentage';
        document.getElementById('rto-quantity-section').style.display = 'none';
        document.getElementById('rto-percentage-section').style.display = 'block';
    } else {
        document.getElementById('rto-method-label').textContent = 'Calculate by Quantity';
        document.getElementById('rto-quantity-section').style.display = 'block';
        document.getElementById('rto-percentage-section').style.display = 'none';
    }
});

// Setup sale form handlers
function setupSaleFormHandlers(mode, firebaseId = null) {
    const addBtn = document.getElementById('add-sale');
    const newAddBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newAddBtn, addBtn);
    
    if (mode === 'add') {
        newAddBtn.innerHTML = '<i>➕</i> Add Sale';
        newAddBtn.addEventListener('click', addNewSale);
    } else {
        newAddBtn.innerHTML = '<i>🔄</i> Update Sale';
        newAddBtn.addEventListener('click', function() { updateSale(firebaseId); });
    }
}

// Edit Sale
window.editSale = function(firebaseId) {
    const sale = businessData.sales.find(s => s.firebaseId === firebaseId);
    if (!sale) return;

    // Set currently editing
    currentlyEditing.sale = firebaseId;
    document.getElementById('cancel-edit-sale').classList.remove('hidden');

    // Populate form
    document.getElementById('sale-date').value = sale.date;
    document.getElementById('product-name').value = sale.productName;
    document.getElementById('quantity-sold').value = sale.quantity;
    document.getElementById('sale-price').value = sale.salePrice;
    document.getElementById('product-cost').value = sale.productCost;
    document.getElementById('total-ads-cost').value = sale.totalAdsCost;
    document.getElementById('packaging-cost').value = sale.packagingCost || 0;
    document.getElementById('shipping-cost').value = sale.shippingCost || 0;
    document.getElementById('sale-notes').value = sale.notes || '';

    // Handle RTO
    if (sale.rtoQuantity > 0) {
        document.getElementById('rto-quantity').value = sale.rtoQuantity;
        document.getElementById('rto-charge').value = sale.rtoCharge || (sale.totalRTOAmount / sale.rtoQuantity - sale.productCost);
    } else {
        document.getElementById('rto-quantity').value = 0;
        document.getElementById('rto-charge').value = 0;
    }

    // Handle discounts
    discountEntries = sale.discounts ? sale.discounts.map(d => ({
        quantity: d.quantity,
        type: d.type,
        value: d.value,
        id: Date.now().toString()
    })) : [];
    updateDiscountDisplay();

    // Handle other charges
    otherCharges = sale.otherCharges ? sale.otherCharges.map(c => ({
        name: c.name,
        type: c.type,
        value: c.value,
        id: Date.now().toString()
    })) : [];
    updateOtherChargesDisplay();

    // Setup handlers
    setupSaleFormHandlers('edit', firebaseId);
    
    // Scroll to form
    document.getElementById('profit-section').scrollIntoView({ behavior: 'smooth' });
};

// Cancel edit sale
document.getElementById('cancel-edit-sale').addEventListener('click', function() {
    resetSaleForm();
});

function resetSaleForm() {
    document.getElementById('sale-date').value = '';
    document.getElementById('product-name').value = '';
    document.getElementById('quantity-sold').value = '';
    document.getElementById('sale-price').value = '';
    document.getElementById('product-cost').value = '';
    document.getElementById('total-ads-cost').value = '';
    document.getElementById('packaging-cost').value = '0';
    document.getElementById('shipping-cost').value = '0';
    document.getElementById('rto-quantity').value = '0';
    document.getElementById('rto-charge').value = '0';
    document.getElementById('rto-percentage').value = '0';
    document.getElementById('rto-percentage-charge').value = '0';
    document.getElementById('sale-notes').value = '';
    
    // Reset discount and charges
    discountEntries = [];
    otherCharges = [];
    updateDiscountDisplay();
    updateOtherChargesDisplay();
    
    // Reset button handlers
    setupSaleFormHandlers('add');
    
    document.getElementById('cancel-edit-sale').classList.add('hidden');
    currentlyEditing.sale = null;
}

// Add new sale with discount calculation
function addNewSale() {
    const date = document.getElementById('sale-date').value;
    const productName = document.getElementById('product-name').value;
    const quantity = parseInt(document.getElementById('quantity-sold').value);
    const salePrice = parseFloat(document.getElementById('sale-price').value);
    const productCost = parseFloat(document.getElementById('product-cost').value);
    const totalAdsCost = parseFloat(document.getElementById('total-ads-cost').value);
    const packagingCost = parseFloat(document.getElementById('packaging-cost').value) || 0;
    const shippingCost = parseFloat(document.getElementById('shipping-cost').value) || 0;
    const notes = document.getElementById('sale-notes').value;
    
    if (!date || !productName || isNaN(quantity) || quantity <= 0 || 
        isNaN(salePrice) || salePrice <= 0 || isNaN(productCost) || productCost < 0 ||
        isNaN(totalAdsCost) || totalAdsCost < 0) {
        showToast('Please fill all required fields with valid values', 'error');
        return;
    }
    
    // Calculate RTO based on selected method
    let rtoQuantity = 0;
    let rtoCharge = 0;
    
    if (rtoCalculationMethod) {
        // Calculate by percentage
        const rtoPercentage = parseFloat(document.getElementById('rto-percentage').value) || 0;
        rtoCharge = parseFloat(document.getElementById('rto-percentage-charge').value) || 0;
        
        if (rtoPercentage > 0) {
            rtoQuantity = Math.round(quantity * (rtoPercentage / 100));
        }
    } else {
        // Calculate by quantity
        rtoQuantity = parseInt(document.getElementById('rto-quantity').value) || 0;
        rtoCharge = parseFloat(document.getElementById('rto-charge').value) || 0;
    }
    
    // Calculate RTO cost (product cost + RTO charge per unit)
    const rtoProductCost = rtoQuantity * ((salePrice - productCost) + rtoCharge);
    
    // Calculate total revenue before discount
    const totalRevenueBeforeDiscount = quantity * salePrice;
    
    // Calculate discount amounts
    let totalDiscountAmount = 0;
    const appliedDiscounts = [];
    
    let remainingQuantity = quantity;
    discountEntries.sort((a, b) => a.quantity - b.quantity).forEach(discount => {
        if (remainingQuantity <= 0) return;
        
        const applicableQuantity = Math.min(discount.quantity, remainingQuantity);
        let discountAmount = 0;
        
        if (discount.type === 'percentage') {
            discountAmount = applicableQuantity * salePrice * (discount.value / 100);
        } else {
            discountAmount = discount.value * applicableQuantity;
        }
        
        totalDiscountAmount += discountAmount;
        remainingQuantity -= applicableQuantity;
        
        appliedDiscounts.push({
            quantity: applicableQuantity,
            type: discount.type,
            value: discount.value,
            amount: discountAmount
        });
    });
    
    // Calculate total revenue after discount
    const totalRevenueAfterDiscount = totalRevenueBeforeDiscount - totalDiscountAmount;
    
    // Calculate product cost (without other expenses)
    const totalProductCost = quantity * productCost;
    
    // Calculate margin (revenue after discount minus product cost)
    const margin = (totalRevenueAfterDiscount - totalProductCost) - rtoProductCost;
    
    // Calculate other charges based on margin (not total sales)
    let totalOtherChargesAmount = 0;
    const appliedOtherCharges = [];
    
    otherCharges.forEach(charge => {
        let chargeAmount = 0;
        
        if (charge.type === 'percentage') {
            chargeAmount = margin * (charge.value / 100);
        } else {
            chargeAmount = charge.value;
        }
        
        totalOtherChargesAmount += chargeAmount;
        
        appliedOtherCharges.push({
            name: charge.name,
            type: charge.type,
            value: charge.value,
            amount: chargeAmount
        });
    });
    
    // Calculate total cost including shipping, packaging, RTO and other charges
    const totalCost = totalProductCost + totalAdsCost + rtoProductCost + 
                     shippingCost + packagingCost + totalOtherChargesAmount;
    
    // Calculate profit (margin minus other expenses)
    const profit = margin - (totalAdsCost + shippingCost + packagingCost + totalOtherChargesAmount); 
    
    showLoading('sale-spinner');
    
    const newSale = {
        date,
        productName,
        quantity,
        salePrice,
        productCost,
        totalProductCost,
        totalAdsCost,
        adsCostPerUnit: totalAdsCost / quantity,
        rtoQuantity,
        rtoCharge,
        rtoProductCost,
        totalRTOAmount: rtoProductCost,
        packagingCost,
        shippingCost,
        otherCharges: appliedOtherCharges,
        totalOtherChargesAmount,
        discounts: appliedDiscounts,
        totalDiscountAmount,
        totalRevenueBeforeDiscount,
        totalRevenueAfterDiscount,
        margin,
        totalCost,
        profit,
        notes,
        addedBy: currentUser,
        timestamp: new Date().toISOString()
    };
    
    // Push to Firebase
    database.ref('businessData/sales').push(newSale)
        .then(() => {
            hideLoading('sale-spinner');
            resetSaleForm();
            showToast('Sale added successfully');
        })
        .catch((error) => {
            hideLoading('sale-spinner');
            console.error("Error adding sale: ", error);
            showToast('Error adding sale', 'error');
        });
}

// Update sale
async function updateSale(firebaseId) {
    const date = document.getElementById('sale-date').value;
    const productName = document.getElementById('product-name').value;
    const quantity = parseInt(document.getElementById('quantity-sold').value);
    const salePrice = parseFloat(document.getElementById('sale-price').value);
    const productCost = parseFloat(document.getElementById('product-cost').value);
    const totalAdsCost = parseFloat(document.getElementById('total-ads-cost').value);
    const packagingCost = parseFloat(document.getElementById('packaging-cost').value) || 0;
    const shippingCost = parseFloat(document.getElementById('shipping-cost').value) || 0;
    const notes = document.getElementById('sale-notes').value;
    
    if (!date || !productName || isNaN(quantity) || quantity <= 0 || 
        isNaN(salePrice) || salePrice <= 0 || isNaN(productCost) || productCost < 0 ||
        isNaN(totalAdsCost) || totalAdsCost < 0) {
        showToast('Please fill all required fields with valid values', 'error');
        return;
    }
    
    // Calculate RTO based on selected method
    let rtoQuantity = 0;
    let rtoCharge = 0;
    
    if (rtoCalculationMethod) {
        // Calculate by percentage
        const rtoPercentage = parseFloat(document.getElementById('rto-percentage').value) || 0;
        rtoCharge = parseFloat(document.getElementById('rto-percentage-charge').value) || 0;
        
        if (rtoPercentage > 0) {
            rtoQuantity = Math.round(quantity * (rtoPercentage / 100));
        }
    } else {
        // Calculate by quantity
        rtoQuantity = parseInt(document.getElementById('rto-quantity').value) || 0;
        rtoCharge = parseFloat(document.getElementById('rto-charge').value) || 0;
    }
    
    // Calculate RTO cost (product cost + RTO charge per unit)
    const rtoProductCost = rtoQuantity * ((salePrice - productCost) + rtoCharge);
    
    // Calculate total revenue before discount
    const totalRevenueBeforeDiscount = quantity * salePrice;
    
    // Calculate discount amounts
    let totalDiscountAmount = 0;
    const appliedDiscounts = [];
    
    let remainingQuantity = quantity;
    discountEntries.sort((a, b) => a.quantity - b.quantity).forEach(discount => {
        if (remainingQuantity <= 0) return;
        
        const applicableQuantity = Math.min(discount.quantity, remainingQuantity);
        let discountAmount = 0;
        
        if (discount.type === 'percentage') {
            discountAmount = applicableQuantity * salePrice * (discount.value / 100);
        } else {
            discountAmount = discount.value * applicableQuantity;
        }
        
        totalDiscountAmount += discountAmount;
        remainingQuantity -= applicableQuantity;
        
        appliedDiscounts.push({
            quantity: applicableQuantity,
            type: discount.type,
            value: discount.value,
            amount: discountAmount
        });
    });
    
    // Calculate total revenue after discount
    const totalRevenueAfterDiscount = totalRevenueBeforeDiscount - totalDiscountAmount;
    
    // Calculate product cost (without other expenses)
    const totalProductCost = quantity * productCost;
    
    // Calculate margin (revenue after discount minus product cost)
    const margin = (totalRevenueAfterDiscount - totalProductCost) - rtoProductCost;
    
    // Calculate other charges based on margin (not total sales)
    let totalOtherChargesAmount = 0;
    const appliedOtherCharges = [];
    
    otherCharges.forEach(charge => {
        let chargeAmount = 0;
        
        if (charge.type === 'percentage') {
            chargeAmount = margin * (charge.value / 100);
        } else {
            chargeAmount = charge.value;
        }
        
        totalOtherChargesAmount += chargeAmount;
        
        appliedOtherCharges.push({
            name: charge.name,
            type: charge.type,
            value: charge.value,
            amount: chargeAmount
        });
    });
    
    // Calculate total cost including shipping, packaging, RTO and other charges
    const totalCost = totalProductCost + totalAdsCost + rtoProductCost + 
                     shippingCost + packagingCost + totalOtherChargesAmount;
    
    // Calculate profit (margin minus other expenses)
    const profit = margin - (totalAdsCost + shippingCost + packagingCost + totalOtherChargesAmount); 
    
    showLoading('sale-spinner');
    
    const updatedSale = {
        date,
        productName,
        quantity,
        salePrice,
        productCost,
        totalProductCost,
        totalAdsCost,
        adsCostPerUnit: totalAdsCost / quantity,
        rtoQuantity,
        rtoCharge,
        rtoProductCost,
        totalRTOAmount: rtoProductCost,
        packagingCost,
        shippingCost,
        otherCharges: appliedOtherCharges,
        totalOtherChargesAmount,
        discounts: appliedDiscounts,
        totalDiscountAmount,
        totalRevenueBeforeDiscount,
        totalRevenueAfterDiscount,
        margin,
        totalCost,
        profit,
        notes,
        updatedBy: currentUser,
        updatedAt: new Date().toISOString()
    };
    
    try {
        // Update in Firebase
        await database.ref(`businessData/sales/${firebaseId}`).update(updatedSale);
        
        hideLoading('sale-spinner');
        resetSaleForm();
        showToast('Sale updated successfully');
    } catch (error) {
        hideLoading('sale-spinner');
        console.error("Error updating sale: ", error);
        showToast('Error updating sale', 'error');
    }
}

// Add discount entry
document.getElementById('add-discount').addEventListener('click', function() {
    const quantity = parseInt(document.getElementById('discount-quantity').value);
    const type = document.getElementById('discount-type').value;
    const value = parseFloat(document.getElementById('discount-value').value);
    
    if (isNaN(quantity) || quantity <= 0) {
        showToast('Please enter valid quantity', 'error');
        return;
    }
    
    if (isNaN(value) || value <= 0) {
        showToast('Please enter valid discount value', 'error');
        return;
    }
    
    // Add to discount entries array
    discountEntries.push({
        quantity,
        type,
        value,
        id: Date.now().toString()
    });
    
    // Update discount display
    updateDiscountDisplay();
    
    // Reset form
    document.getElementById('discount-value').value = '';
    showToast('Discount added');
});

// Add other charge entry
document.getElementById('add-other-charge').addEventListener('click', function() {
    const name = document.getElementById('other-charge-name').value;
    const type = document.getElementById('other-charge-type').value;
    const value = parseFloat(document.getElementById('other-charge-value').value);
    
    if (!name) {
        showToast('Please enter charge name', 'error');
        return;
    }
    
    if (isNaN(value) || value <= 0) {
        showToast('Please enter valid charge value', 'error');
        return;
    }
    
    // Add to other charges array
    otherCharges.push({
        name,
        type,
        value,
        id: Date.now().toString()
    });
    
    // Update other charges display
    updateOtherChargesDisplay();
    
    // Reset form
    document.getElementById('other-charge-name').value = '';
    document.getElementById('other-charge-value').value = '';
    showToast('Charge added');
});

// Update discount display
function updateDiscountDisplay() {
    const container = document.getElementById('discount-container');
    container.innerHTML = '';
    
    if (discountEntries.length === 0) {
        container.innerHTML = '<p class="empty-state">No discounts added</p>';
        return;
    }
    
    discountEntries.forEach(discount => {
        const discountDiv = document.createElement('div');
        discountDiv.className = 'discount-entry';
        
        discountDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>${discount.quantity} product(s)</strong> - 
                    ${discount.type === 'percentage' ? discount.value + '%' : '₹' + discount.value}
                </div>
                <button class="delete-btn" onclick="removeDiscount('${discount.id}')">Remove</button>
            </div>
        `;
        
        container.appendChild(discountDiv);
    });
}

// Update other charges display
function updateOtherChargesDisplay() {
    const container = document.getElementById('other-charges-container');
    container.innerHTML = '';
    
    if (otherCharges.length === 0) {
        container.innerHTML = '<p class="empty-state">No other charges added</p>';
        return;
    }
    
    otherCharges.forEach(charge => {
        const chargeDiv = document.createElement('div');
        chargeDiv.className = 'discount-entry';
        
        chargeDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>${charge.name}</strong> - 
                    ${charge.type === 'percentage' ? charge.value + '%' : '₹' + charge.value}
                </div>
                <button class="delete-btn" onclick="removeOtherCharge('${charge.id}')">Remove</button>
            </div>
        `;
        
        container.appendChild(chargeDiv);
    });
}

// Remove discount
window.removeDiscount = function(id) {
    discountEntries = discountEntries.filter(d => d.id !== id);
    updateDiscountDisplay();
    showToast('Discount removed');
};

// Remove other charge
window.removeOtherCharge = function(id) {
    otherCharges = otherCharges.filter(c => c.id !== id);
    updateOtherChargesDisplay();
    showToast('Charge removed');
};

// Profit Sharing
document.getElementById('calculate-profit').addEventListener('click', function() {
    const month = parseInt(document.getElementById('profit-month').value);
    const year = parseInt(document.getElementById('profit-year').value);
    
    // Filter sales for selected month/year
    const monthlySales = businessData.sales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate.getMonth() + 1 === month && saleDate.getFullYear() === year;
    });
    
    const totalProfit = monthlySales.reduce((sum, sale) => sum + sale.profit, 0);
    const sahilShare = totalProfit * 0.5;
    const aarifShare = totalProfit * 0.5;
    
    // Update UI
    document.getElementById('monthly-total-profit').textContent = `₹${totalProfit.toFixed(2)}`;
    document.getElementById('sahil-share').textContent = `₹${sahilShare.toFixed(2)}`;
    document.getElementById('aarif-share').textContent = `₹${aarifShare.toFixed(2)}`;
    
    showLoading('profit-sharing-spinner');
    
    const profitShareEntry = {
        month,
        year,
        totalProfit,
        sahilShare,
        aarifShare,
        calculatedBy: currentUser,
        timestamp: new Date().toISOString()
    };
    
    // Push to Firebase
    database.ref('businessData/profitSharing').push(profitShareEntry)
        .then(() => {
            hideLoading('profit-sharing-spinner');
            showToast('Profit sharing calculated and saved successfully');
        })
        .catch((error) => {
            hideLoading('profit-sharing-spinner');
            console.error("Error saving profit sharing: ", error);
            showToast('Error saving profit sharing', 'error');
        });
});

// Edit Profit Sharing
window.editProfitShare = function(firebaseId) {
    const profitShare = businessData.profitSharing.find(ps => ps.firebaseId === firebaseId);
    if (!profitShare) return;

    // Populate form
    document.getElementById('profit-month').value = profitShare.month;
    document.getElementById('profit-year').value = profitShare.year;
    
    // Update UI
    document.getElementById('monthly-total-profit').textContent = `₹${profitShare.totalProfit.toFixed(2)}`;
    document.getElementById('sahil-share').textContent = `₹${profitShare.sahilShare.toFixed(2)}`;
    document.getElementById('aarif-share').textContent = `₹${profitShare.aarifShare.toFixed(2)}`;
    
    // Scroll to form
    document.getElementById('profit-sharing-section').scrollIntoView({ behavior: 'smooth' });
};

// Setup receipt form handlers
function setupReceiptFormHandlers(mode, firebaseId = null) {
    const uploadBtn = document.getElementById('upload-receipt');
    const newUploadBtn = uploadBtn.cloneNode(true);
    uploadBtn.parentNode.replaceChild(newUploadBtn, uploadBtn);
    
    if (mode === 'add') {
        newUploadBtn.innerHTML = '<i>📤</i> Upload';
        newUploadBtn.addEventListener('click', uploadNewReceipt);
    } else {
        newUploadBtn.innerHTML = '<i>🔄</i> Update Receipt';
        newUploadBtn.addEventListener('click', function() { updateReceipt(firebaseId); });
    }
}

// Receipt Upload
document.getElementById('receipt-file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const filePreview = document.getElementById('file-preview');
    const fileInfo = document.getElementById('file-info');
    const previewImage = document.getElementById('preview-image');
    
    filePreview.style.display = 'block';
    fileInfo.textContent = `${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
    
    if (file.type.startsWith('image/')) {
        previewImage.style.display = 'block';
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImage.src = e.target.result;
        };
        reader.readAsDataURL(file);
    } else {
        previewImage.style.display = 'none';
    }
});

// Edit Receipt
window.editReceipt = function(firebaseId) {
    const receipt = businessData.receipts.find(r => r.firebaseId === firebaseId);
    if (!receipt) return;

    // Set currently editing
    currentlyEditing.receipt = firebaseId;
    document.getElementById('cancel-edit-receipt').classList.remove('hidden');

    // Populate form
    document.getElementById('receipt-date').value = receipt.date;
    document.getElementById('receipt-type').value = receipt.type;
    document.getElementById('receipt-description').value = receipt.description || '';
    
    // Show file info
    const filePreview = document.getElementById('file-preview');
    const fileInfo = document.getElementById('file-info');
    filePreview.style.display = 'block';
    fileInfo.textContent = `${receipt.fileName} (${(receipt.fileSize / 1024).toFixed(2)} KB)`;
    
    // Setup handlers
    setupReceiptFormHandlers('edit', firebaseId);
    
    // Scroll to form
    document.getElementById('receipts-section').scrollIntoView({ behavior: 'smooth' });
};

// Cancel edit receipt
document.getElementById('cancel-edit-receipt').addEventListener('click', function() {
    resetReceiptForm();
});

function resetReceiptForm() {
    document.getElementById('receipt-date').value = '';
    document.getElementById('receipt-type').value = 'invoice';
    document.getElementById('receipt-description').value = '';
    document.getElementById('receipt-file').value = '';
    document.getElementById('file-preview').style.display = 'none';
    
    // Reset button handlers
    setupReceiptFormHandlers('add');
    
    document.getElementById('cancel-edit-receipt').classList.add('hidden');
    currentlyEditing.receipt = null;
}

// Upload new receipt
function uploadNewReceipt() {
    const date = document.getElementById('receipt-date').value;
    const type = document.getElementById('receipt-type').value;
    const description = document.getElementById('receipt-description').value;
    const fileInput = document.getElementById('receipt-file');
    
    if (!date || !fileInput.files[0]) {
        showToast('Please select a date and file', 'error');
        return;
    }
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    showLoading('receipt-spinner');
    
    reader.onload = function(e) {
        const newReceipt = {
            date,
            type,
            description,
            fileName: file.name,
            fileType: file.type,
            fileSize: file.size,
            fileData: e.target.result.split(',')[1],
            uploadedBy: currentUser,
            timestamp: new Date().toISOString()
        };
        
        // Push to Firebase
        database.ref('businessData/receipts').push(newReceipt)
            .then(() => {
                hideLoading('receipt-spinner');
                resetReceiptForm();
                showToast('Receipt uploaded successfully');
            })
            .catch((error) => {
                hideLoading('receipt-spinner');
                console.error("Error uploading receipt: ", error);
                showToast('Error uploading receipt', 'error');
            });
    };
    
    reader.readAsDataURL(file);
}

// Update receipt
async function updateReceipt(firebaseId) {
    const date = document.getElementById('receipt-date').value;
    const type = document.getElementById('receipt-type').value;
    const description = document.getElementById('receipt-description').value;
    const fileInput = document.getElementById('receipt-file');
    
    if (!date) {
        showToast('Please select a date', 'error');
        return;
    }
    
    showLoading('receipt-spinner');
    
    try {
        const updatedReceipt = {
            date,
            type,
            description,
            updatedBy: currentUser,
            updatedAt: new Date().toISOString()
        };
        
        // If new file is selected, upload it
        if (fileInput.files[0]) {
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                updatedReceipt.fileName = file.name;
                updatedReceipt.fileType = file.type;
                updatedReceipt.fileSize = file.size;
                updatedReceipt.fileData = e.target.result.split(',')[1];
                
                // Update in Firebase
                database.ref(`businessData/receipts/${firebaseId}`).update(updatedReceipt)
                    .then(() => {
                        hideLoading('receipt-spinner');
                        resetReceiptForm();
                        showToast('Receipt updated successfully');
                    })
                    .catch((error) => {
                        hideLoading('receipt-spinner');
                        console.error("Error updating receipt: ", error);
                        showToast('Error updating receipt', 'error');
                    });
            };
            
            reader.readAsDataURL(file);
        } else {
            // Update without changing the file
            await database.ref(`businessData/receipts/${firebaseId}`).update(updatedReceipt);
            
            hideLoading('receipt-spinner');
            resetReceiptForm();
            showToast('Receipt updated successfully');
        }
    } catch (error) {
        hideLoading('receipt-spinner');
        console.error("Error updating receipt: ", error);
        showToast('Error updating receipt', 'error');
    }
}

// View PDF receipt
window.viewPDF = function(fileData) {
    const modal = document.getElementById('pdf-modal');
    const pdfViewer = document.getElementById('pdf-viewer');
    
    // Clear previous content
    pdfViewer.innerHTML = '';
    
    // Show loading message
    pdfViewer.innerHTML = '<p>Loading PDF...</p>';
    
    // Open modal
    modal.style.display = 'block';
    
    // Decode base64 to binary
    const binaryString = atob(fileData);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    
    // Load PDF
    pdfjsLib.getDocument(bytes).promise.then(function(pdf) {
        // Clear loading message
        pdfViewer.innerHTML = '';
        
        // Create a container for all pages
        const container = document.createElement('div');
        
        // Load all pages
        const numPages = pdf.numPages;
        for (let i = 1; i <= numPages; i++) {
            pdf.getPage(i).then(function(page) {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                const viewport = page.getViewport({ scale: 1.5 });
                
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                container.appendChild(canvas);
                
                page.render({
                    canvasContext: context,
                    viewport: viewport
                });
            });
        }
        
        pdfViewer.appendChild(container);
    }).catch(function(error) {
        pdfViewer.innerHTML = '<p>Error loading PDF: ' + error.message + '</p>';
    });
};

// Close modal when clicking X
document.querySelector('.close-modal').addEventListener('click', function() {
    document.getElementById('pdf-modal').style.display = 'none';
});

// Close modal when clicking outside
window.addEventListener('click', function(event) {
    if (event.target === document.getElementById('pdf-modal')) {
        document.getElementById('pdf-modal').style.display = 'none';
    }
});

// Delete functions
async function deleteInvestment(firebaseId) {
    if (!confirm('Are you sure you want to delete this investment?')) return;
    
    try {
        await database.ref(`businessData/investments/${firebaseId}`).remove();
        showToast('Investment deleted successfully');
    } catch (error) {
        console.error("Error deleting investment:", error);
        showToast(`Error deleting investment: ${error.message}`, 'error');
    }
}

async function deleteExpense(firebaseId) {
    if (!confirm('Are you sure you want to delete this expense?')) return;
    
    try {
        await database.ref(`businessData/expenses/${firebaseId}`).remove();
        showToast('Expense deleted successfully');
    } catch (error) {
        console.error("Error deleting expense:", error);
        showToast(`Error deleting expense: ${error.message}`, 'error');
    }
}

async function deleteSale(firebaseId) {
    if (!confirm('Are you sure you want to delete this sale?')) return;
    
    try {
        await database.ref(`businessData/sales/${firebaseId}`).remove();
        showToast('Sale deleted successfully');
    } catch (error) {
        console.error("Error deleting sale:", error);
        showToast(`Error deleting sale: ${error.message}`, 'error');
    }
}

async function deleteProfitShare(firebaseId) {
    if (!confirm('Are you sure you want to delete this profit sharing entry?')) return;
    
    try {
        await database.ref(`businessData/profitSharing/${firebaseId}`).remove();
        showToast('Profit sharing entry deleted successfully');
    } catch (error) {
        console.error("Error deleting profit sharing entry:", error);
        showToast(`Error deleting profit sharing entry: ${error.message}`, 'error');
    }
}

async function deleteReceipt(firebaseId) {
    if (!confirm('Are you sure you want to delete this receipt?')) return;
    
    try {
        await database.ref(`businessData/receipts/${firebaseId}`).remove();
        showToast('Receipt deleted successfully');
    } catch (error) {
        console.error("Error deleting receipt:", error);
        showToast(`Error deleting receipt: ${error.message}`, 'error');
    }
}

// Date filters
document.getElementById('investment-date-filter').addEventListener('change', function() {
    updateInvestmentTable(this.value);
});

document.getElementById('reset-investment-filter').addEventListener('click', function() {
    document.getElementById('investment-date-filter').value = '';
    updateInvestmentTable();
});

document.getElementById('expense-date-filter').addEventListener('change', function() {
    updateExpenseTable(this.value);
});

document.getElementById('reset-expense-filter').addEventListener('click', function() {
    document.getElementById('expense-date-filter').value = '';
    updateExpenseTable();
});

document.getElementById('profit-date-filter').addEventListener('change', function() {
    updateProfitTable(this.value);
});

document.getElementById('reset-profit-filter').addEventListener('click', function() {
    document.getElementById('profit-date-filter').value = '';
    updateProfitTable();
});

document.getElementById('receipt-date-filter').addEventListener('change', function() {
    updateReceiptsTable(this.value);
});

document.getElementById('reset-receipt-filter').addEventListener('click', function() {
    document.getElementById('receipt-date-filter').value = '';
    updateReceiptsTable();
});

// Search functionality
document.getElementById('investment-search').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    updateInvestmentTable('', searchTerm);
});

document.getElementById('expense-search').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    updateExpenseTable('', searchTerm);
});

document.getElementById('profit-search').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    updateProfitTable('', searchTerm);
});

document.getElementById('profit-sharing-search').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    updateProfitSharingTable(searchTerm);
});

document.getElementById('receipts-search').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    updateReceiptsTable('', searchTerm);
});

// Update recent activity on home page
function updateRecentActivity() {
    // Recent sales
    const recentSalesList = document.getElementById('recent-sales-list');
    recentSalesList.innerHTML = '';
    
    const recentSales = [...businessData.sales]
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5);
    
    if (recentSales.length === 0) {
        recentSalesList.innerHTML = '<p class="empty-state">No recent sales</p>';
    } else {
        recentSales.forEach(sale => {
            const saleItem = document.createElement('div');
            saleItem.className = 'discount-entry';
            saleItem.innerHTML = `
                <div style="display: flex; justify-content: space-between;">
                    <div>
                        <strong>${sale.productName}</strong>
                        <div style="font-size: 12px; color: var(--gray);">${sale.date}</div>
                    </div>
                    <div style="text-align: right;">
                        <div>${sale.quantity} × ₹${sale.salePrice.toFixed(2)}</div>
                        <div style="font-weight: 600; color: ${sale.profit >= 0 ? 'var(--success)' : 'var(--danger)'}">
                            ₹${sale.profit.toFixed(2)}
                        </div>
                    </div>
                </div>
            `;
            recentSalesList.appendChild(saleItem);
        });
    }
    
    // Recent expenses
    const recentExpensesList = document.getElementById('recent-expenses-list');
    recentExpensesList.innerHTML = '';
    
    const recentExpenses = [...businessData.expenses]
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5);
    
    if (recentExpenses.length === 0) {
        recentExpensesList.innerHTML = '<p class="empty-state">No recent expenses</p>';
    } else {
        recentExpenses.forEach(expense => {
            const expenseItem = document.createElement('div');
            expenseItem.className = 'discount-entry';
            expenseItem.innerHTML = `
                <div style="display: flex; justify-content: space-between;">
                    <div>
                        <strong>${expense.category}</strong>
                        <div style="font-size: 12px; color: var(--gray);">${expense.date}</div>
                    </div>
                    <div style="text-align: right;">
                        <div>₹${expense.amount.toFixed(2)}</div>
                        <div style="font-size: 12px; color: var(--gray);">
                            Paid by ${expense.paidBy === 'business' ? 'Business' : (expense.paidBy === 'sahil' ? 'Sahil' : 'Aarif')}
                        </div>
                    </div>
                </div>
            `;
            recentExpensesList.appendChild(expenseItem);
        });
    }
}

// Update tables
function updateInvestmentTable(filterDate = '', searchTerm = '') {
    const tbody = document.getElementById('investment-table').querySelector('tbody');
    tbody.innerHTML = '';
    
    let filteredInvestments = businessData.investments || [];
    let sahilTotal = 0;
    let aarifTotal = 0;
    let overallTotal = 0;
    
    if (filterDate) {
        filteredInvestments = filteredInvestments.filter(
            inv => inv.date === filterDate
        );
    }
    
    if (searchTerm) {
        filteredInvestments = filteredInvestments.filter(inv => 
            inv.partner.toLowerCase().includes(searchTerm) ||
            inv.category.toLowerCase().includes(searchTerm) ||
            (inv.notes && inv.notes.toLowerCase().includes(searchTerm)) ||
            inv.amount.toString().includes(searchTerm)
        );
    }
    
    if (filteredInvestments.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
                No investments found
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    filteredInvestments.forEach(inv => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${inv.date}</td>
            <td>${inv.partner === 'sahil' ? 'Sahil' : 'Aarif'}</td>
            <td>₹${inv.amount.toFixed(2)}</td>
            <td>${inv.category}</td>
            <td>${inv.notes || '-'}</td>
            <td class="table-actions">
                <button class="edit-btn" onclick="editInvestment('${inv.firebaseId}')">Edit</button>
                <button class="delete-btn" onclick="deleteInvestment('${inv.firebaseId}')">Delete</button>
            </td>
        `;
        tbody.appendChild(row);
        
        if (inv.partner === 'sahil') sahilTotal += inv.amount;
        if (inv.partner === 'aarif') aarifTotal += inv.amount;
        overallTotal += inv.amount;
    });
    
    // Update all investment summary cards
    document.getElementById('sahil-investment').textContent = `₹${sahilTotal.toFixed(2)}`;
    document.getElementById('aarif-investment').textContent = `₹${aarifTotal.toFixed(2)}`;
    document.getElementById('total-investment-summary').textContent = `₹${overallTotal.toFixed(2)}`;
    document.getElementById('total-investment').textContent = `₹${overallTotal.toFixed(2)}`;
}

function updateExpenseTable(filterDate = '', searchTerm = '') {
    const tbody = document.getElementById('expense-table').querySelector('tbody');
    tbody.innerHTML = '';
    
    let filteredExpenses = businessData.expenses || [];
    let totalExpenses = 0;
    let monthlyExpenses = 0;
    
    if (filterDate) {
        filteredExpenses = filteredExpenses.filter(
            exp => exp.date === filterDate
        );
    }
    
    if (searchTerm) {
        filteredExpenses = filteredExpenses.filter(exp => 
            exp.category.toLowerCase().includes(searchTerm) ||
            (exp.notes && exp.notes.toLowerCase().includes(searchTerm)) ||
            exp.amount.toString().includes(searchTerm) ||
            exp.paidBy.toLowerCase().includes(searchTerm)
        );
    }
    
    if (filteredExpenses.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
                No expenses found
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    // Calculate monthly expenses (current month)
    const currentMonth = new Date().getMonth() + 1;
    const currentYear = new Date().getFullYear();
    filteredExpenses.forEach(exp => {
        const expDate = new Date(exp.date);
        if (expDate.getMonth() + 1 === currentMonth && expDate.getFullYear() === currentYear) {
            monthlyExpenses += exp.amount;
        }
    });
    
    filteredExpenses.forEach(exp => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${exp.date}</td>
            <td>₹${exp.amount.toFixed(2)}</td>
            <td>${exp.category}</td>
            <td>${exp.paidBy === 'business' ? 'Business' : (exp.paidBy === 'sahil' ? 'Sahil' : 'Aarif')}</td>
            <td>${exp.notes || '-'}</td>
            <td class="table-actions">
                <button class="edit-btn" onclick="editExpense('${exp.firebaseId}')">Edit</button>
                <button class="delete-btn" onclick="deleteExpense('${exp.firebaseId}')">Delete</button>
            </td>
        `;
        tbody.appendChild(row);
        totalExpenses += exp.amount;
    });
    
    document.getElementById('total-expenses-summary').textContent = `₹${totalExpenses.toFixed(2)}`;
    document.getElementById('monthly-expenses').textContent = `₹${monthlyExpenses.toFixed(2)}`;
    document.getElementById('total-expenses').textContent = `₹${totalExpenses.toFixed(2)}`;
}

function updateProfitTable(filterDate = '', searchTerm = '') {
    const tbody = document.getElementById('profit-table').querySelector('tbody');
    tbody.innerHTML = '';
    
    let filteredSales = businessData.sales || [];
    let totalSalesBeforeDiscount = 0;
    let totalSalesAfterDiscount = 0;
    let totalProductCost = 0;
    let totalMargin = 0;
    let totalProfit = 0;
    let totalRTOCost = 0;
    let totalAdsCost = 0;
    let totalDiscount = 0;
    let totalShipping = 0;
    let totalPackaging = 0;
    let totalOtherCharges = 0;
    
    if (filterDate) {
        filteredSales = filteredSales.filter(
            sale => sale.date === filterDate
        );
    }
    
    if (searchTerm) {
        filteredSales = filteredSales.filter(sale => 
            sale.productName.toLowerCase().includes(searchTerm) ||
            (sale.notes && sale.notes.toLowerCase().includes(searchTerm)) ||
            sale.salePrice.toString().includes(searchTerm) ||
            sale.productCost.toString().includes(searchTerm)
        );
    }
    
    if (filteredSales.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="15" style="text-align: center; padding: 20px; color: var(--gray);">
                No sales found
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    filteredSales.forEach(sale => {
        // Format discount display
        let discountDisplay = '-';
        if (sale.discounts && sale.discounts.length > 0) {
            discountDisplay = sale.discounts.map(d => 
                `${d.quantity} pcs - ${d.type === 'percentage' ? d.value + '%' : '₹' + d.value}`
            ).join('<br>');
        }
        
        // Format other charges display
        let otherChargesDisplay = '-';
        if (sale.otherCharges && sale.otherCharges.length > 0) {
            otherChargesDisplay = sale.otherCharges.map(c => 
                `${c.name}: ${c.type === 'percentage' ? c.value + '%' : '₹' + c.value}`
            ).join('<br>');
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${sale.date}</td>
            <td>${sale.productName}</td>
            <td>${sale.quantity}</td>
            <td>₹${sale.salePrice.toFixed(2)}</td>
            <td>${discountDisplay}</td>
            <td>₹${sale.productCost.toFixed(2)}</td>
            <td>₹${sale.totalAdsCost.toFixed(2)}</td>
            <td>₹${sale.totalRTOAmount.toFixed(2)} (${sale.rtoQuantity} units)</td>
            <td>${otherChargesDisplay}</td>
            <td>${sale.packagingCost ? '₹' + sale.packagingCost.toFixed(2) : '-'}</td>
            <td>${sale.shippingCost ? '₹' + sale.shippingCost.toFixed(2) : '-'}</td>
            <td>₹${sale.margin.toFixed(2)}</td>
            <td class="${sale.profit >= 0 ? 'text-success' : 'text-danger'}">
                ₹${sale.profit.toFixed(2)}
            </td>
            <td>${sale.notes || '-'}</td>
            <td class="table-actions">
                <button class="edit-btn" onclick="editSale('${sale.firebaseId}')">Edit</button>
                <button class="delete-btn" onclick="deleteSale('${sale.firebaseId}')">Delete</button>
            </td>
        `;
        tbody.appendChild(row);
        
        totalSalesBeforeDiscount += sale.totalRevenueBeforeDiscount;
        totalSalesAfterDiscount += sale.totalRevenueAfterDiscount;
        totalProductCost += sale.totalProductCost;
        totalMargin += sale.margin;
        totalProfit += sale.profit;
        totalRTOCost += sale.totalRTOAmount;
        totalAdsCost += sale.totalAdsCost;
        totalDiscount += sale.totalDiscountAmount;
        totalShipping += sale.shippingCost;
        totalPackaging += sale.packagingCost;
        totalOtherCharges += sale.totalOtherChargesAmount;
    });
    
    // Update the summary cards
    document.getElementById('total-sales').textContent = `₹${totalSalesAfterDiscount.toFixed(2)}`;
    document.getElementById('total-cost').textContent = `₹${totalProductCost.toFixed(2)}`;
    document.getElementById('total-margin').textContent = `₹${totalMargin.toFixed(2)}`;
    document.getElementById('total-profit-summary').textContent = `₹${totalProfit.toFixed(2)}`;
    document.getElementById('total-rto-cost').textContent = `₹${totalRTOCost.toFixed(2)}`;
    document.getElementById('total-other-charges').textContent = `₹${totalOtherCharges.toFixed(2)}`;
    document.getElementById('total-discount').textContent = `₹${totalDiscount.toFixed(2)}`;
    document.getElementById('total-profit').textContent = `₹${totalProfit.toFixed(2)}`;
    
    // Update your share on home page
    if (currentUser) {
        const yourShare = totalProfit * 0.5;
        document.getElementById('your-share').textContent = `₹${yourShare.toFixed(2)}`;
    }
}

function updateReceiptsTable(filterDate = '', searchTerm = '') {
    const tbody = document.getElementById('receipts-table').querySelector('tbody');
    tbody.innerHTML = '';
    
    let filteredReceipts = businessData.receipts || [];
    
    if (filterDate) {
        filteredReceipts = filteredReceipts.filter(
            rec => rec.date === filterDate
        );
    }
    
    if (searchTerm) {
        filteredReceipts = filteredReceipts.filter(rec => 
            rec.type.toLowerCase().includes(searchTerm) ||
            (rec.description && rec.description.toLowerCase().includes(searchTerm)) ||
            rec.fileName.toLowerCase().includes(searchTerm) ||
            rec.uploadedBy.toLowerCase().includes(searchTerm)
        );
    }
    
    if (filteredReceipts.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
                No receipts found
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    filteredReceipts.forEach(rec => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${rec.date}</td>
            <td>${rec.type}</td>
            <td>${rec.description || '-'}</td>
            <td>
                <a href="#" class="view-receipt" data-id="${rec.firebaseId}" data-file="${rec.fileData}" data-type="${rec.fileType}">
                    ${rec.fileName}
                </a>
            </td>
            <td>${rec.uploadedBy === 'sahilkhant587@gmail.com' ? 'Sahil' : 'Aarif'}</td>
            <td class="table-actions">
                <button class="edit-btn" onclick="editReceipt('${rec.firebaseId}')">Edit</button>
                <button class="delete-btn" onclick="deleteReceipt('${rec.firebaseId}')">Delete</button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Add event listeners to view receipts
    document.querySelectorAll('.view-receipt').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const fileData = this.getAttribute('data-file');
            const fileType = this.getAttribute('data-type');
            
            if (fileType.startsWith('image/')) {
                const imgWindow = window.open('', '_blank');
                imgWindow.document.write(`
                    <html>
                        <body style="margin:0;padding:0;text-align:center;">
                            <img src="data:${fileType};base64,${fileData}" style="max-width:100%;max-height:100vh;">
                        </body>
                    </html>
                `);
            } else if (fileType === 'application/pdf') {
                viewPDF(fileData);
            } else {
                alert('File preview is only available for images and PDFs');
            }
        });
    });
}

function updateProfitSharingTable(searchTerm = '') {
    const tbody = document.getElementById('profit-sharing-table').querySelector('tbody');
    tbody.innerHTML = '';
    
    let profitSharingData = businessData.profitSharing || [];
    
    if (searchTerm) {
        profitSharingData = profitSharingData.filter(ps => 
            ps.totalProfit.toString().includes(searchTerm) ||
            ps.sahilShare.toString().includes(searchTerm) ||
            ps.aarifShare.toString().includes(searchTerm)
        );
    }
    
    if (profitSharingData.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="5" style="text-align: center; padding: 20px; color: var(--gray);">
                No profit sharing entries found
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    profitSharingData.forEach(ps => {
        const monthNames = ["January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"];
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${monthNames[ps.month - 1]} ${ps.year}</td>
            <td>₹${ps.totalProfit.toFixed(2)}</td>
            <td>₹${ps.sahilShare.toFixed(2)}</td>
            <td>₹${ps.aarifShare.toFixed(2)}</td>
            <td class="table-actions">
                <button class="edit-btn" onclick="editProfitShare('${ps.firebaseId}')">Edit</button>
                <button class="delete-btn" onclick="deleteProfitShare('${ps.firebaseId}')">Delete</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Update entire dashboard
function updateDashboard() {
    updateInvestmentTable();
    updateExpenseTable();
    updateProfitTable();
    updateReceiptsTable();
    updateProfitSharingTable();
    updateRecentActivity();
}

// Initialize dates
function initDates() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('invest-date').value = today;
    document.getElementById('expense-date').value = today;
    document.getElementById('sale-date').value = today;
    document.getElementById('receipt-date').value = today;
    
    // Set current month in profit sharing
    const currentMonth = new Date().getMonth() + 1;
    document.getElementById('profit-month').value = currentMonth;
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initDates();
    
    // Initialize form handlers
    setupInvestmentFormHandlers('add');
    setupExpenseFormHandlers('add');
    setupSaleFormHandlers('add');
    setupReceiptFormHandlers('add');
    
    // Make functions available globally
    window.deleteInvestment = deleteInvestment;
    window.deleteExpense = deleteExpense;
    window.deleteSale = deleteSale;
    window.deleteProfitShare = deleteProfitShare;
    window.deleteReceipt = deleteReceipt;
    window.removeDiscount = removeDiscount;
    window.removeOtherCharge = removeOtherCharge;
    window.editInvestment = editInvestment;
    window.editExpense = editExpense;
    window.editSale = editSale;
    window.editProfitShare = editProfitShare;
    window.editReceipt = editReceipt;
    window.viewPDF = viewPDF;
});
    </script>
</body>
</html>